<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>3.3. Configuration Application</title><link rel="stylesheet" href="docbook.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="Config5"><link rel="up" href="ch03.html" title="Chapter 3. Configuration Application"><link rel="prev" href="ch03s02.html" title="3.2. Environment"><link rel="next" href="ch04.html" title="Chapter 4. The config5 Script"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.3. Configuration Application</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><th width="60%" align="center">Chapter 3. Configuration Application</th><td width="20%" align="right"> <a accesskey="n" href="ch04.html">Next</a></td></tr></table><hr></div><div class="section" title="3.3. Configuration Application"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp472832"></a>3.3. Configuration Application</h2></div></div></div>
    

    <p>The configuration is applied after processing in a structured
    manner.</p>

    <div class="section" title="3.3.1. Passes"><div class="titlepage"><div><div><h3 class="title"><a name="app.passes"></a>3.3.1. Passes</h3></div></div></div>
      

      <p>The configuration is applied in ten
      <span class="emphasis"><em><em class="firstterm">passes</em></em></span>. The pass in which a
      change is applied can be specified with the flags <code class="option">-0</code> to
      <code class="option">-9</code> for each change. The default pass is
      <code class="constant">1</code>.</p>

      <p>Applying the configuration in multiple passes can be helpful in a
      couple of scenarios:</p>

      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>Changes that must be done before or after everything else can
          be placed in an earlier or later pass.</p>
        </li><li class="listitem">
          <p>Configuration files that are generated by a command that
          writes a temporary file which is copied to the final
          destination.</p>
        </li></ul></div>
    </div>

    <div class="section" title="3.3.2. Phases"><div class="titlepage"><div><div><h3 class="title"><a name="app.phases"></a>3.3.2. Phases</h3></div></div></div>
      

      <p>In each pass the relevant changes are applied in different phases.
      Currently the following phases are defined and processed in this
      order:</p>

      <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
          <p>Install or remove packages</p>
        </li><li class="listitem">
          <p>Delete files and directories</p>
        </li><li class="listitem">
          <p>Create files and directories</p>
        </li><li class="listitem">
          <p>Modify files and directories</p>
        </li><li class="listitem">
          <p>Configure system</p>
        </li><li class="listitem">
          <p>Execute commands</p>
        </li></ol></div>

      <p>Each type of change is applied in exactly one phase:</p>

      <div class="variablelist"><dl><dt><span class="term">Install or remove packages</span></dt><dd>
            <p>(not used by the core changes)</p>
          </dd><dt><span class="term">Delete files and directories</span></dt><dd>
            <p><code class="function">remove</code></p>
          </dd><dt><span class="term">Create files and directories</span></dt><dd>
            <p><code class="function">append</code>, <code class="function">copy</code>,
            <code class="function">directory</code>, <code class="function">link</code>,
            <code class="function">symlink</code>, <code class="function">truncate</code></p>
          </dd><dt><span class="term">Modify files and directories</span></dt><dd>
            <p>(not used by the core changes)</p>
          </dd><dt><span class="term">Configure system</span></dt><dd>
            <p>(not used by the core changes)</p>
          </dd><dt><span class="term">Execute commands</span></dt><dd>
            <p><code class="function">execute</code>,
            <code class="function">service</code></p>
          </dd></dl></div>

      <p>For each phase the order in which changes are applied is also
      defined:</p>

      <div class="variablelist"><dl><dt><span class="term">Install or remove packages</span></dt><dd>
            <p>All changes are applied in the order the changes were
            processed (see <a class="xref" href="ch03.html#app.proc" title="3.1. Configuration Processing">Section 3.1, “Configuration Processing”</a>).</p>
          </dd><dt><span class="term">Delete files and directories</span></dt><dd>
            <p>All changes are ordered according to the <span class="emphasis"><em>reverse
            alphabetical order</em></span> of the destination path and applied
            in this order. Files are deleted before their parent
            directory.</p>
          </dd><dt><span class="term">Create files and directories</span></dt><dd>
            <p>All changes are ordered according to the
            <span class="emphasis"><em>alphabetical order</em></span> of the destination path
            and applied in this order. Directories are created before files
            they contain.</p>
          </dd><dt><span class="term">Modify files and directories</span></dt><dd>
            <p>All changes are ordered according to the
            <span class="emphasis"><em>alphabetical order</em></span> of the destination path
            and applied in this order. Directories are created before files
            they contain.</p>
          </dd><dt><span class="term">Configure system</span></dt><dd>
            <p>All changes are applied in the order the changes were
            processed (see <a class="xref" href="ch03.html#app.proc" title="3.1. Configuration Processing">Section 3.1, “Configuration Processing”</a>).</p>
          </dd><dt><span class="term">Execute commands</span></dt><dd>
            <p>All changes are applied in the order the changes were
            processed (see <a class="xref" href="ch03.html#app.proc" title="3.1. Configuration Processing">Section 3.1, “Configuration Processing”</a>).</p>
          </dd></dl></div>

      <div class="section" title="3.3.2.1. Data Generation"><div class="titlepage"><div><div><h4 class="title"><a name="app.generation"></a>3.3.2.1. Data Generation</h4></div></div></div>
        

        <p>Before the files are copied in phase <code class="constant">3</code> of
        each pass, the content of files are generated. This is done on two
        steps:</p>

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>The source data of all append and copy changes that are not
            marked as binary using the <code class="option">-b</code> flag is processed
            using Template Toolkit.</p>
          </li><li class="listitem">
            <p>The processed data from all <code class="function">append</code>
            changes is appended to the processed data of the respective
            <code class="function">copy</code> or <code class="function">truncate</code>
            changes.</p>
          </li></ol></div>

        <p>The processed data is not written to the destination files yet
        but kept in memory for use during the actual configuration
        application.</p>

        <div class="important" title="Important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3>
          <p>Copying large files may use up a lot of memory because of the
          intermediate copy in memory.</p>
        </div>
      </div>
    </div>

    <div class="section" title="3.3.3. Changes"><div class="titlepage"><div><div><h3 class="title"><a name="app.changes"></a>3.3.3. Changes</h3></div></div></div>
      

      <p>For each change that is applied <span class="command"><strong>config5</strong></span> will
      first check if there are modifications needed. Changes that require no
      modifications on the target system are not shown in the default
      verbosity level.</p>

      <p>The following subsections describe how each change type is
      applied.</p>

      <div class="section" title="3.3.3.1. copy and truncate"><div class="titlepage"><div><div><h4 class="title"><a name="idp529728"></a>3.3.3.1. <code class="function">copy</code> and
        <code class="function">truncate</code></h4></div></div></div>
        

        <p>When applying a <code class="function">copy</code> or
        <code class="function">truncate</code> change <span class="command"><strong>config5</strong></span> will
        do it with as few side effects as possible. A file is only replaced or
        created if it is missing or its content (or file type) changes in
        which case <span class="command"><strong>config5</strong></span> does the following:</p>

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>If the file already exists but is not a plain file then it
            will be deleted first.</p>
          </li><li class="listitem">
            <p>It will create a temporary file with the new content and set
            all permissions as specified. If SELinux is enabled and no SELinux
            context is specified and the file is replaced then the context
            from the current file is copied to the temporary file.</p>
          </li><li class="listitem">
            <p>The temporary file is renamed to the real file name which
            also deletes the old file.</p>
          </li></ol></div>

        <p>If <span class="emphasis"><em>in-place</em></span> modification is explicitly
        enabled using the <code class="option">-i</code> flag then the existing file is
        modified directly instead and <span class="command"><strong>config5</strong></span> does the
        following:</p>

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>If the file already exists but is not a plain file then it
            will be deleted first.</p>
          </li><li class="listitem">
            <p>It will write the new content to the file.</p>
          </li></ol></div>

        <p>If the file is already present and the content is the same then
        only the properties such as user, group, mode or SELinux context (if
        enabled) are modified if necessary.</p>
      </div>

      <div class="section" title="3.3.3.2. directory"><div class="titlepage"><div><div><h4 class="title"><a name="idp541984"></a>3.3.3.2. <code class="function">directory</code></h4></div></div></div>
        

        <p>If a file exists with the same path as the directory it is
        removed.</p>
      </div>

      <div class="section" title="3.3.3.3. execute"><div class="titlepage"><div><div><h4 class="title"><a name="idp543504"></a>3.3.3.3. <code class="function">execute</code></h4></div></div></div>
        

        <p>The command line is executed by the default shell of the user
        who is running <span class="command"><strong>config5</strong></span>.</p>
      </div>

      <div class="section" title="3.3.3.4. link"><div class="titlepage"><div><div><h4 class="title"><a name="idp544656"></a>3.3.3.4. <code class="function">link</code></h4></div></div></div>
        

        <p>If the link is missing or does not have the same device and
        inode number as the file it links to <span class="command"><strong>config5</strong></span> does
        the following:</p>

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>It will create a temporary link to the source file</p>
          </li><li class="listitem">
            <p>The temporary link is renamed to the real file name which
            also deletes the old link.</p>
          </li></ol></div>
      </div>

      <div class="section" title="3.3.3.5. remove"><div class="titlepage"><div><div><h4 class="title"><a name="idp550080"></a>3.3.3.5. <code class="function">remove</code></h4></div></div></div>
        

        <p>If the file or directory exists it will be removed.</p>

        <div class="important" title="Important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3>
          <p>Recursively deleting directories is not supported at this
          time. Use an <code class="function">execute</code> change to run
          <span class="command"><strong>rm</strong></span> instead.</p>
        </div>
      </div>

      <div class="section" title="3.3.3.6. symlink"><div class="titlepage"><div><div><h4 class="title"><a name="idp551952"></a>3.3.3.6. <code class="function">symlink</code></h4></div></div></div>
        

        <p>If the symbolic link is missing or does not have the right
        content <span class="command"><strong>config5</strong></span> does the following:</p>

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>If the file already exists but is not a symbolic link then
            it will be deleted first.</p>
          </li><li class="listitem">
            <p>It will create a temporary symbolic link with the new
            content and set all permissions as specified. If SELinux is
            enabled and no SELinux context is specified and the symbolic link
            is replaced then the context from the current symbolic link is
            copied to the temporary symbolic link.</p>
          </li><li class="listitem">
            <p>The temporary symbolic link is renamed to the real file name
            which also deletes the old symbolic link.</p>
          </li></ol></div>
      </div>

      <div class="section" title="3.3.3.7. properties"><div class="titlepage"><div><div><h4 class="title"><a name="idp559120"></a>3.3.3.7. properties</h4></div></div></div>
        

        <p>The file or directory must exist. The properties such as user,
        group, mode or SELinux context (if enabled) are modified if
        necessary.</p>
      </div>
    </div>

    <div class="section" title="3.3.4. Triggered Changes"><div class="titlepage"><div><div><h3 class="title"><a name="app.triggers"></a>3.3.4. Triggered Changes</h3></div></div></div>
      

      <p>A simple mechanism exists to make the application of changes
      depend on the modifications of previous changes. The most common case
      where this is used is to restart a service after updating its
      configuration files.</p>

      <p>Each class and each feature has a <span class="emphasis"><em>triggered</em></span>
      flag which are cleared before configuration application. Every change
      that requires a relevant modification (see <a class="xref" href="ch03s03.html#app.triggers.relevant" title="3.3.4.1. Relevant Modifications">Section 3.3.4.1, “Relevant Modifications”</a>) to the target system will set the
      triggered flags of its class and feature. Each change can be flagged to
      be triggered using either the <code class="option">-t</code> or <code class="option">-T</code>
      flag. In this case the change is only applied if the triggered flag of
      the class (<code class="option">-t</code>) or the feature (<code class="option">-T</code>) of
      the change is set.</p>

      <p>The following facts are also relevant when working with triggered
      changes:</p>

      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>The flags are kept across all phases and passes</p>
        </li><li class="listitem">
          <p>Triggered changes never set the triggered flags</p>
        </li></ul></div>

      <div class="section" title="3.3.4.1. Relevant Modifications"><div class="titlepage"><div><div><h4 class="title"><a name="app.triggers.relevant"></a>3.3.4.1. Relevant Modifications</h4></div></div></div>
        

        <p>Not every modification that is done when a change is applied
        sets the triggered flags. The following table lists the modifications
        that set or do not set the triggered flags:</p>

        <div class="informaltable">
          <table border="1"><colgroup><col align="left"><col><col></colgroup><thead><tr><th align="left">Change</th><th>Triggered Flag Set</th><th align="left">No Change</th></tr></thead><tbody><tr><td align="left"><code class="function">append</code></td><td>Never</td><td> </td></tr><tr><td align="left"><code class="function">copy</code></td><td>File missing or not a plain file,content
                changed</td><td>Change of user, group, mode or other properties</td></tr><tr><td align="left"><code class="function">directory</code></td><td>Directory missing or not a directory</td><td>Change of user, group, mode or other properties</td></tr><tr><td align="left"><code class="function">execute</code></td><td>Never</td><td> </td></tr><tr><td align="left"><code class="function">link</code></td><td>Link missing or to different inode</td><td> </td></tr><tr><td align="left"><code class="function">properties</code></td><td>Change of user, group, mode or other properties</td><td> </td></tr><tr><td align="left"><code class="function">remove</code></td><td>File or directory existing</td><td> </td></tr><tr><td align="left"><code class="function">symlink</code></td><td>Symbolic link missing or not a symbolic link, content
                changed</td><td>Change of user, group or other properties</td></tr><tr><td align="left"><code class="function">truncate</code></td><td>File missing or not a plain file,content
                changed</td><td>Change of user, group, mode or other properties</td></tr></tbody></table>
        </div>
      </div>
    </div>
  </div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch03.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch04.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3.2. Environment </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 4. The <span class="command"><strong>config5 Script</strong></span></td></tr></table></div></body></html>
